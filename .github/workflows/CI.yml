name: CI Pipeline

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    ci:
        runs-on: ubuntu-latest

        # 1 Load the code from the repository to use in the workflow
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # 2 Setup Node.js environment
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            # 3 Install dependencies for backend
            - name: Install dependencies
              run: npm run install:all

            # 4 Lint the backend code
            - name: Lint Backend
              run: npm run lint:backend

            # 5 Test the backend code
            - name: Test Backend
              run: npm run test:backend

            # 6 Lint the frontend code
            - name: Lint Frontend
              run: npm run lint:frontend

            # 7 Test the frontend code
            - name: Test Frontend
              run: npm run test:frontend

            # 8 Check vulnerable dependencies
            - name: Audit Dependencies
              run: npm audit --audit-level=moderate

            # 9 Initialize CodeQL for security analysis
            - name: Initialize CodeQL
              uses: github/codeql-action/init@v4
              with:
                  languages: javascript

            # 10 Perform CodeQL analysis
            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v4

            # 11 Build Docker image for backend
            - name: Build Backend Docker Image
              working-directory: ./backend
              run: docker build -t task-backend:latest .

            # 12 Build Docker image for frontend
            - name: Build Frontend Docker Image
              working-directory: ./frontend
              run: |
                  docker build \
                    --build-arg VITE_API_URL=http://localhost:5000/api \
                    -t task-frontend:latest .
